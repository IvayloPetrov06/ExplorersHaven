@using Explorers_Haven.ViewModels.Main
@model OfferPageViewModel

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@Model.OfferName - Explorers Haven</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div>
        <div>
            <h1>@Model.OfferName</h1>
            <div>
                <div>
                    @if (Model.OfferRatingStars == 5)
                    {
                        <input value="5" name="rating" id="star5" type="radio" checked>
                    }
                    else
                    {
                        <input value="5" name="rating" id="star5" type="radio">
                    }
                    <label for="star5"></label>
                    @if (Model.OfferRatingStars == 4)
                    {
                        <input value="4" name="rating" id="star4" type="radio" checked>
                    }
                    else
                    {
                        <input value="4" name="rating" id="star4" type="radio">
                    }
                    <label for="star4"></label>
                    @if (Model.OfferRatingStars == 3)
                    {
                        <input value="3" name="rating" id="star3" type="radio" checked>
                    }
                    else
                    {
                        <input value="3" name="rating" id="star3" type="radio">
                    }
                    <label for="star3"></label>
                    @if (Model.OfferRatingStars == 2)
                    {
                        <input value="2" name="rating" id="star2" type="radio" checked>
                    }
                    else
                    {
                        <input value="2" name="rating" id="star2" type="radio">
                    }
                    <label for="star2"></label>
                    @if (Model.OfferRatingStars == 1)
                    {
                        <input value="1" name="rating" id="star1" type="radio" checked>
                    }
                    else
                    {
                        <input value="1" name="rating" id="star1" type="radio">
                    }
                    <label for="star1"></label>
                </div>
                <span>@Model.OfferRating</span>
            </div>
        </div>

        <div>
            <input type="checkbox" id="favorite" name="favorite-checkbox" value="favorite-button">
            <label for="favorite">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-heart"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                <div>
                    <span>Add to Favorites</span>
                    <span>Added to Favorites</span>
                </div>
            </label>
        </div>

        <div>
            <img src="@Model.OfferPic" alt="@Model.OfferName">
        </div>

        <div>
            <div>
                <div>Description</div>
                <div>@Model.OfferDisc</div>
            </div>

            <div>
                <div>
                    <div>Price per person</div>
                    <div>@Model.OfferPrice лв</div>
                </div>
                <form method="post" action="/Booking/Book">
                    <!-- Hidden field for offer ID -->
                    <input type="hidden" name="id" value="@Model.OfferId" />

                    <!-- People Count Input -->
                    <label for="ppl">People Count:</label>
                    <input type="number" id="ppl" name="ppl" required min="1" />

                    <br>

                    <!-- Discounted People Count Input -->
                    <label for="discppl">Discounted People Count:</label>
                    <input type="number" id="discppl" name="discppl" required min="0" />

                    <br>

                    <!-- Start Date Input -->
                    <label for="st">Start Date:</label>
                    <input type="date" id="st" name="st" required />

                    <br><br>

                    <!-- Submit Button -->
                    <button type="submit">Book Now</button>
                </form>
                <form method="post" enctype="multipart/form-data">
                <div>
                    <a href="/Booking/Book/@Model.OfferId">Book Now</a>
                    <a href="/Booking/Cancel/@Model.OfferId">Cancel</a>
                </div>
                <</form>/>
            </div>
        </div>

        <h2>Accommodation Details</h2>
        <div>
            <div>
                <h3>@Model.StayName</h3>
                <div>
                    @for (int i = 0; i < Model.StayStars; i++)
                    {
                        <span>★</span>
                    }
                </div>
            </div>

            <p>@Model.StayDisc</p>
            <div>@Model.StayPrice лв</div>
            <img src="@Model.StayPic" alt="@Model.StayName">
        </div>

        <h2>Travel Details</h2>
        @foreach (var a in Model.Travels)
        {
            <div>
                <div>
                    <div>@a.Start</div>
                    <div>@a.DateStart.ToString()</div>
                </div>
                <img src="/Images/Plane.svg" alt="Plane" />
                <div>
                    <div>@a.Finish</div>
                    <div>@a.DateFinish</div>
                </div>
                <div>@a.Transport</div>
            </div>
        }

        <h2>Activities</h2>
        <div>
            @foreach (var a in Model.Activities)
            {
                <div>
                    <h3>@a.CoverImage</h3>
                </div>
                <div>
                    <h3>@a.Name</h3>
                </div>
            }
        </div>

        <div>
            <h2>Reviews</h2>
            <form id="commentForm" method="POST">
                <input type="text" id="userInput" name="userInput" placeholder="Share your experience..." />
                <button type="submit">Submit</button>
            </form>

            <div id="commentsSection">
                @foreach (var a in Model.Comments)
                {
                    <div>
                        @foreach (var u in Model.Users)
                        {
                            if (u.Id == a.UserId)
                            {
                                <img src="@u.ProfilePicture">
                            }
                        }
                        <div>@a.Content</div>
                    </div>
                }
            </div>
        </div>
    </div>

    <script>
        if(false) {
        $(document).ready(function() {
            var stars = document.querySelector(".rating").querySelectorAll("input");

            stars.forEach(function(star) {
                star.addEventListener('click', async function() {
                    const url = "/Rating/Rate/@Model.OfferId?rating=" + this.value;
                    try {
                        const response = await fetch(url);
                        const json = await response.json();
                        console.log(json);
                    } catch (error) {
                        alert("Error rating this offer");
                    }
                });
            });

            document.querySelector("#commentForm").addEventListener("submit", async function(event) {
                event.preventDefault();

                const comment = document.querySelector("#userInput").value;
                const offerId = @Model.OfferId;
                const url = `/Comment/WriteComment/${offerId}?comment=${encodeURIComponent(comment)}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const json = await response.json();
                    console.log(json);

                    if (json.success) {
                        const commentDiv = document.createElement("div");

                        const profilePic = document.createElement("img");
                        profilePic.src = json.profilePicture;

                        const commentContent = document.createElement("div");
                        commentContent.textContent = json.commentContent;

                        commentDiv.appendChild(profilePic);
                        commentDiv.appendChild(commentContent);

                        const commentsSection = document.querySelector("#commentsSection");
                        commentsSection.prepend(commentDiv);

                        document.querySelector("#userInput").value = '';
                    } else {
                        alert("Failed to add comment.");
                    }
                } catch (error) {
                    console.error(error);
                    alert("Error occurred while submitting the comment.");
                }
            });
        });
        }
    </script>
</body>